<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Failsafe Settings</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #1e1e1e; color: #ddd; margin: 0; }
    header { padding: 12px 16px; background: #2b2b2b; border-bottom: 1px solid #3a3a3a; display:flex; gap:16px; align-items:center; }
    main { padding: 16px; }
    .panel { background: #252525; border: 1px solid #3a3a3a; border-radius: 6px; padding: 12px; max-width: 780px; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
    .row label { display: inline-flex; align-items: center; gap: 6px; margin-right: 8px; }
    .row label select, .row label input { width: auto; }
    .actions .row { flex-wrap: wrap; }
    label { display: block; }
    input[type=text], input[type=number], select { padding: 6px 8px; border-radius: 4px; border: 1px solid #555; background: #1f1f1f; color: #ddd; }
    button { padding: 6px 10px; border-radius: 4px; border: 1px solid #555; background: #333; color: #eee; cursor: pointer; }
    button:hover { background: #3d3d3d; }
    small { color: #999; }
    .actions { display:flex; flex-direction:column; gap:6px; max-height: 40vh; overflow-y:auto; padding-right:6px; }
    .action { border: 1px dashed #555; border-radius: 4px; padding: 6px; background: #1a1a1a; }
    nav a { color: #9bd; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .no-drag { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -webkit-user-drag: none; }
  </style>
</head>
<body>
  <header>
    <div><strong>Failsafe Settings</strong></div>
    <nav style="display:flex; gap:12px">
      <a href="/">Dashboard</a>
      <a href="/static/sequences.html">Sequences</a>
      <a href="/static/groups.html">Groups</a>
      <a href="/static/control.html">Controls</a>
      <a href="/static/schedules.html">Schedules</a>
      <a href="/static/templates.html">Templates</a>
      <a href="/static/failsafe.html">Failsafe</a>
      <a href="/static/debug.html">Debug</a>
    </nav>
    <div style="margin-left:auto; display:flex; align-items:center; gap:8px">
      <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="rememberToken" /> Remember token</label>
      <input type="text" id="token" placeholder="Access Token" style="width:260px" />
    </div>
  </header>
  <main>
    <div class="panel">
      <div class="row">
        <label style="min-width:160px">Enabled
          <select id="fsEnabled"><option>false</option><option>true</option></select>
        </label>
      </div>
      <div class="row">
        <label style="min-width:160px">Template
          <select id="fsTemplate"></select>
        </label>
        <label style="min-width:160px">Confidence
          <input type="number" id="fsConfidence" min="0" max="1" step="0.01" />
        </label>
      </div>
      <div class="row">
        <label style="min-width:160px">Region (x,y,w,h)
          <input type="text" id="fsRegion" placeholder="e.g., 100,100,800,600" />
        </label>
      </div>
      <div class="row">
        <button id="btnSave">Save Failsafe</button>
        <small id="status">Status: idle</small>
      </div>
    </div>
    <div class="panel" style="margin-top:16px">
      <h3>Failsafe Sequence Steps</h3>
      <div id="steps" style="display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow-y:auto; padding-right:8px"></div>
      <div class="row">
        <button id="btnFsAddStep">Add Step</button>
        <label style="flex:1">Add Group Call
          <select id="fsGroupSelect"></select>
        </label>
        <button id="btnFsAddGroupCall">Add Group Call</button>
      </div>
    </div>
    <div class="panel" style="margin-top:16px">
      <h4>Live Preview (Select Region)</h4>
      <div id="fsPreviewWrap" style="width:100%">
        <div class="row" style="margin-bottom:8px">
          <label>Monitor
            <select id="fsMonitor"></select>
          </label>
          <label style="margin-left:16px">Size
            <select id="fsPreviewSize"><option>640</option><option>800</option><option selected>1024</option><option>1280</option></select>
          </label>
          <label style="margin-left:16px; display:inline-flex; align-items:center; gap:6px"><input type="checkbox" id="fsPhoneToggle" /> Using Phone</label>
        </div>
        <div id="fsImagePane" style="position:relative; width:100%">
          <img id="fsPreview" alt="Preview" draggable="false" class="no-drag" style="width:100%; max-height:60vh; object-fit:contain; background:#111; border:1px solid #3a3a3a; border-radius:6px" />
          <div id="fsSel" style="position:absolute; border:2px solid #4af; background:rgba(64,160,255,0.2); display:none"></div>
        </div>
      </div>
      <small>Click-drag on the preview to select a region; use "Use Preview Region" on a step or set global region above.</small>
      <div class="row" style="margin-top:8px">
        <button id="btnFsUsePreviewRegion">Use Preview as Failsafe Region</button>
      </div>
    </div>
  </main>

  <script>
    const apiBase = '';
    const tokenEl = document.getElementById('token');
    const rememberEl = document.getElementById('rememberToken');
    const statusEl = document.getElementById('status');
    let templates = [];
    let lastFsRegion = null;

    function authHeaders() {
      const tok = tokenEl.value.trim();
      return tok ? { 'Authorization': `Bearer ${tok}` } : {};
    }

    // Token persistence across pages
    try {
      const remembered = (localStorage.getItem('rememberToken') === 'true');
      rememberEl.checked = remembered;
      const savedTok = localStorage.getItem('apiToken') || '';
      if (remembered && savedTok && !tokenEl.value) tokenEl.value = savedTok;
    } catch (e) {}
    tokenEl.addEventListener('change', () => {
      try { if (rememberEl.checked) localStorage.setItem('apiToken', tokenEl.value.trim()); } catch (e) {}
      // Use correct loaders so defaults appear in inputs
      loadTemplates(); loadFailsafe(); loadFailsafeSteps(); fetchFsMonitors().then(updateFsPreviewSrc); fetchFsGroups();
    });
    rememberEl.addEventListener('change', () => {
      try {
        localStorage.setItem('rememberToken', rememberEl.checked ? 'true' : 'false');
        if (rememberEl.checked) localStorage.setItem('apiToken', tokenEl.value.trim());
      } catch (e) {}
    });

    async function loadTemplates() {
      try {
        const res = await fetch(`${apiBase}/api/templates`, { headers: authHeaders() });
        const data = await res.json();
        templates = (data.templates || []).map(t => t.name);
        const sel = document.getElementById('fsTemplate');
        sel.innerHTML = '';
        const noneOpt = document.createElement('option'); noneOpt.value = ''; noneOpt.textContent = '(none)'; sel.appendChild(noneOpt);
        for (const t of (data.templates || [])) { const opt = document.createElement('option'); opt.value = t.name; opt.textContent = t.name; sel.appendChild(opt); }
      } catch (e) { /* ignore */ }
    }

    async function loadFailsafe() {
      try {
        const res = await fetch(`${apiBase}/api/failsafe`, { headers: authHeaders() });
        const fs = await res.json();
        document.getElementById('fsEnabled').value = String(!!fs.enabled);
        document.getElementById('fsTemplate').value = fs.template_name || '';
        document.getElementById('fsConfidence').value = (fs.confidence != null ? fs.confidence : 0.8);
        const r = fs.region || null;
        document.getElementById('fsRegion').value = (r && Array.isArray(r) && r.length === 4) ? r.join(',') : '';
        statusEl.textContent = 'Status: failsafe loaded';
      } catch (e) { statusEl.textContent = `Status: failed to load (${e.message})`; }
    }

    async function saveFailsafe() {
      try {
        const payload = {
          enabled: (document.getElementById('fsEnabled').value === 'true'),
          template_name: document.getElementById('fsTemplate').value || null,
          confidence: parseFloat(document.getElementById('fsConfidence').value || '0.8'),
          region: (() => {
            const txt = document.getElementById('fsRegion').value.trim();
            if (!txt) return null;
            const parts = txt.split(',').map(v => parseInt(v.trim(), 10));
            if (parts.length !== 4 || parts.some(isNaN)) return null;
            return parts;
          })()
        };
        const res = await fetch(`${apiBase}/api/failsafe`, { method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        statusEl.textContent = 'Status: failsafe saved';
      } catch (e) { statusEl.textContent = `Status: save failed (${e.message})`; }
    }

    async function loadFailsafeSteps() {
      try {
        const res = await fetch(`${apiBase}/api/failsafe/sequence`, { headers: authHeaders() });
        const data = await res.json();
        renderSteps(data.steps || []);
      } catch (e) { /* ignore */ }
    }

    async function fetchFsGroups() {
      try {
        const res = await fetch(`${apiBase}/api/groups`, { headers: authHeaders() });
        const data = await res.json();
        const sel = document.getElementById('fsGroupSelect'); if (!sel) return;
        sel.innerHTML = '';
        for (const g of (data.groups || [])) {
          const opt = document.createElement('option'); opt.value = g; opt.textContent = g; sel.appendChild(opt);
        }
        // Default to first group for quick add if none selected
        if (sel.options.length > 0 && !sel.value) sel.value = sel.options[0].value;
      } catch (e) { /* ignore */ }
    }

    function renderSteps(steps) {
      const stepsEl = document.getElementById('steps');
      stepsEl.innerHTML = '';
      steps.forEach((step, idx) => {
        const div = document.createElement('div');
        div.className = 'step';
        div.style.border = '1px solid #444';
        div.style.borderRadius = '4px';
        div.style.padding = '8px';
        div.style.background = '#212121';
        if (step && typeof step === 'object' && step.call_group) {
          const row = document.createElement('div'); row.className = 'row';
          const lbl = document.createElement('span'); lbl.textContent = 'Group Call';
          const selGroup = document.createElement('select');
          const gs = document.getElementById('fsGroupSelect');
          if (gs) { for (const opt of Array.from(gs.options)) { const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.textContent; selGroup.appendChild(o); } }
          selGroup.value = step.call_group || '';
          const saveGC = document.createElement('button'); saveGC.textContent = 'Save'; saveGC.onclick = async () => {
            try {
              const updated = { call_group: selGroup.value };
              const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ step: updated }) });
              const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
              await loadFailsafeSteps(); statusEl.textContent = `Status: saved group call step #${idx}`;
            } catch (e) { statusEl.textContent = `Status: save failed (${e.message})`; }
          };
          const upBtn = document.createElement('button'); upBtn.textContent = 'Up'; upBtn.onclick = () => reorderFailsafeStep(idx, Math.max(0, idx-1));
          const downBtn = document.createElement('button'); downBtn.textContent = 'Down'; downBtn.onclick = () => reorderFailsafeStep(idx, Math.min(steps.length-1, idx+1));
          const delBtn = document.createElement('button'); delBtn.textContent = `Delete #${idx}`; delBtn.onclick = () => deleteStep(idx);
          row.appendChild(lbl); row.appendChild(selGroup); row.appendChild(saveGC); row.appendChild(upBtn); row.appendChild(downBtn); row.appendChild(delBtn);
          div.appendChild(row);
          stepsEl.appendChild(div);
          return;
        }
        // Render GUI-like controls directly (no raw JSON)
        const row = document.createElement('div');
        row.className = 'row';
        const delBtn = document.createElement('button');
        delBtn.textContent = `Delete #${idx}`;
        delBtn.onclick = () => deleteStep(idx);
        const form = document.createElement('div'); form.className = 'row'; form.style.display = 'flex';
        const inTemplate = document.createElement('select');
        const noneOpt = document.createElement('option'); noneOpt.value = ''; noneOpt.textContent = '(none)'; inTemplate.appendChild(noneOpt);
        templates.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; inTemplate.appendChild(opt); });
        inTemplate.value = step.find || '';
        const selRequired = document.createElement('input'); selRequired.type = 'checkbox'; selRequired.checked = !!step.required;
        const inTimeout = document.createElement('input'); inTimeout.type = 'number'; inTimeout.placeholder = 'timeout'; inTimeout.value = (step.timeout != null ? step.timeout : '');
        const inConfidence = document.createElement('input'); inConfidence.type = 'number'; inConfidence.step = '0.01'; inConfidence.min = '0'; inConfidence.max = '1'; inConfidence.placeholder = 'confidence'; inConfidence.value = (step.confidence != null ? step.confidence : '');
        // Monitor selector
        const inMonitor = document.createElement('input'); inMonitor.type = 'text'; inMonitor.placeholder = 'monitor (All/0/1/2)'; inMonitor.value = (step.monitor != null ? step.monitor : '');
        // Region target selector
        const regionTarget = document.createElement('select'); ['region','search_region'].forEach(rt=>{ const opt=document.createElement('option'); opt.value=rt; opt.textContent=rt; regionTarget.appendChild(opt); }); regionTarget.value='region';
        // No step-level action selector; actions are listed below
        // Labels for clarity
        const lblTemplate = document.createElement('label'); lblTemplate.textContent='Find Template '; lblTemplate.style.minWidth='140px'; lblTemplate.appendChild(inTemplate);
        const lblRequired = document.createElement('label'); lblRequired.textContent='Required '; lblRequired.style.minWidth='100px'; lblRequired.appendChild(selRequired);
        const lblTimeout = document.createElement('label'); lblTimeout.textContent='Timeout (s) '; lblTimeout.style.minWidth='120px'; lblTimeout.appendChild(inTimeout);
        const lblConfidence = document.createElement('label'); lblConfidence.textContent='Confidence '; lblConfidence.style.minWidth='120px'; lblConfidence.appendChild(inConfidence);
        const lblMonitor = document.createElement('label'); lblMonitor.textContent='Monitor '; lblMonitor.style.minWidth='120px'; lblMonitor.appendChild(inMonitor);
        const lblRegionTarget = document.createElement('label'); lblRegionTarget.textContent='Apply Region To '; lblRegionTarget.style.minWidth='140px'; lblRegionTarget.appendChild(regionTarget);
        // Removed: step-level action selector label
        // No action-specific sections in header
        const useRegionBtn = document.createElement('button'); useRegionBtn.textContent = 'Use Preview Region';
        useRegionBtn.onclick = async () => {
          if (!lastFsRegion) { statusEl.textContent = 'Status: select a region on the preview first'; return; }
          try {
            const tgt = regionTarget.value; const updated = { ...step }; updated[tgt] = lastFsRegion;
            const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}`, {
              method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ step: updated })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            if (tgt === 'search_region') {
              regionInfo.textContent = `Search Region: (${lastFsRegion[0]}, ${lastFsRegion[1]}, ${lastFsRegion[2]}x${lastFsRegion[3]})`;
            }
            await loadFailsafeSteps();
            statusEl.textContent = `Status: applied ${tgt} to step #${idx}`;
          } catch (e) { statusEl.textContent = `Status: apply failed (${e.message})`; }
        };
        const saveBtn = document.createElement('button'); saveBtn.textContent = 'Save';
        saveBtn.onclick = async () => {
          try {
            const updated = { ...step };
            // No step-level action selector
            if (inTemplate.value) updated.find = inTemplate.value;
            updated.required = !!selRequired.checked;
            if (inTimeout.value !== '') updated.timeout = parseInt(inTimeout.value, 10);
            if (inConfidence.value !== '') updated.confidence = parseFloat(inConfidence.value);
            if (inMonitor.value !== '') updated.monitor = isNaN(Number(inMonitor.value)) ? inMonitor.value : Number(inMonitor.value);
            // No action-specific fields saved at step header; actions are edited below
            const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}`, {
              method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ step: updated })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            await loadFailsafeSteps();
            statusEl.textContent = `Status: saved step #${idx}`;
          } catch (e) { statusEl.textContent = `Status: save failed (${e.message})`; }
        };
        // Step header (compact)
        form.appendChild(lblTemplate);
        form.appendChild(lblRequired);
        form.appendChild(lblTimeout);
        form.appendChild(lblConfidence);
        // Insert step monitor and advanced fields
        const stepMonitor = document.createElement('select');
        const optG = document.createElement('option'); optG.value = 'GLOBAL'; optG.textContent = 'Use Global'; stepMonitor.appendChild(optG);
        (fsMonitors||[]).forEach(m => { const opt=document.createElement('option'); opt.value=String(m.index); opt.textContent=(m.index===0?`All (${m.width}x${m.height})`:`Monitor ${m.index} (${m.width}x${m.height})`); stepMonitor.appendChild(opt); });
        stepMonitor.value = (step.monitor!=null ? String(step.monitor) : 'GLOBAL');
        const inLoops = document.createElement('input'); inLoops.type='number'; inLoops.placeholder='Step Loops'; inLoops.value=(step.step_loops!=null?step.step_loops:'');
        const selStrategy = document.createElement('select'); ['default','template','feature'].forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=(s==='default'?'Default (template)':s); selStrategy.appendChild(opt); }); selStrategy.value=(step.detection_strategy||'default');
        const inInliers = document.createElement('input'); inInliers.type='number'; inInliers.placeholder='Min Inliers'; inInliers.value=(step.min_inliers!=null?step.min_inliers:'');
        const inRatio = document.createElement('input'); inRatio.type='number'; inRatio.step='0.01'; inRatio.placeholder='Ratio'; inRatio.value=(step.ratio!=null?step.ratio:'');
        const inRansac = document.createElement('input'); inRansac.type='number'; inRansac.step='0.1'; inRansac.placeholder='RANSAC'; inRansac.value=(step.ransac!=null?step.ransac:'');
        const selectSearchBtn = document.createElement('button'); selectSearchBtn.textContent='Select Search Region'; selectSearchBtn.onclick = async () => {
          if (!lastFsRegion) { statusEl.textContent = 'Status: select a region on the preview first'; return; }
          try {
            const updated = { ...step, search_region: lastFsRegion };
            const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ step: updated }) });
            const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            await loadFailsafeSteps(); statusEl.textContent = `Status: applied search_region to step #${idx}`;
          } catch (e) { statusEl.textContent = `Status: apply failed (${e.message})`; }
        };
        const lblStepMonitor=document.createElement('label'); lblStepMonitor.textContent='Step Monitor '; lblStepMonitor.appendChild(stepMonitor);
        form.appendChild(lblStepMonitor);
        form.appendChild(inLoops);
        form.appendChild(selStrategy);
        form.appendChild(inInliers);
        form.appendChild(inRatio);
        form.appendChild(inRansac);
        form.appendChild(lblRegionTarget);
        const regionInfo = document.createElement('small'); const sr = Array.isArray(step.search_region)?step.search_region:null; regionInfo.textContent = sr ? `Search Region: (${sr[0]}, ${sr[1]}, ${sr[2]}x${sr[3]})` : 'Search Region: (none)';
        form.appendChild(regionInfo);
        form.appendChild(saveBtn);
        form.appendChild(useRegionBtn);
        const upBtn = document.createElement('button'); upBtn.textContent = 'Up'; upBtn.onclick = () => reorderFailsafeStep(idx, Math.max(0, idx-1));
        const downBtn = document.createElement('button'); downBtn.textContent = 'Down'; downBtn.onclick = () => reorderFailsafeStep(idx, Math.min(steps.length-1, idx+1));
        // Controls always visible; no toggle button
        row.appendChild(upBtn);
        row.appendChild(downBtn);
        row.appendChild(delBtn);
        div.appendChild(row);
        div.appendChild(form);
        // Render actions within this failsafe step
        const actionsWrap = document.createElement('div'); actionsWrap.className = 'actions';
        const actions = Array.isArray(step.actions) ? step.actions : [];
        actions.forEach((act, aidx) => {
          const aDiv = document.createElement('div'); aDiv.className = 'action';
          const aRow = document.createElement('div'); aRow.className = 'row';
          const aType = document.createElement('select'); ['click','wait','type','drag','move','move_to','keypress','scroll'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; aType.appendChild(opt); }); aType.value = act.type || act.action || 'click';
          const aButton = document.createElement('select'); ['left','right','middle'].forEach(b=>{ const opt=document.createElement('option'); opt.value=b; opt.textContent=b; aButton.appendChild(opt); }); aButton.value = act.button || 'left';
          const aClicks = document.createElement('input'); aClicks.type='number'; aClicks.placeholder='clicks'; aClicks.value=(act.clicks!=null?act.clicks:'');
          const aX = document.createElement('input'); aX.type='number'; aX.placeholder='X'; aX.value=(act.x!=null?act.x:'');
          const aY = document.createElement('input'); aY.type='number'; aY.placeholder='Y'; aY.value=(act.y!=null?act.y:'');
          const aRandom = document.createElement('input'); aRandom.type='checkbox'; aRandom.checked=!!act.random; aRandom.title='Toggle Random';
          const aDuration = document.createElement('input'); aDuration.type='number'; aDuration.placeholder='duration'; aDuration.value=(act.duration!=null?act.duration:'');
          const aUseRegion = document.createElement('button'); aUseRegion.textContent='Select Region';
          aUseRegion.onclick = async () => {
            if (!lastFsRegion) { statusEl.textContent = 'Status: select a region on the preview first'; return; }
            try {
              const updated = { ...act, region: lastFsRegion };
              const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
              const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
              aRegionReadout.textContent = `Region: (${lastFsRegion[0]}, ${lastFsRegion[1]}, ${lastFsRegion[2]}x${lastFsRegion[3]})`;
              await loadFailsafeSteps(); statusEl.textContent = `Status: applied action region #${aidx}`;
            } catch (e) { statusEl.textContent = `Status: apply failed (${e.message})`; }
          };
          const aUseRandomRegion = document.createElement('button'); aUseRandomRegion.textContent='Set Random Region';
          aUseRandomRegion.onclick = async () => {
            if (!lastFsRegion) { statusEl.textContent = 'Status: select a region on the preview first'; return; }
            try {
              const updated = { ...act, random_region: lastFsRegion };
              const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
              const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
              aRandomRegionReadout.textContent = `Random Region: (${lastFsRegion[0]}, ${lastFsRegion[1]}, ${lastFsRegion[2]}x${lastFsRegion[3]})`;
              await loadFailsafeSteps(); statusEl.textContent = `Status: applied action random_region #${aidx}`;
            } catch (e) { statusEl.textContent = `Status: apply failed (${e.message})`; }
          };
          const aRegionReadout = document.createElement('small');
          const arr = Array.isArray(act.region) ? act.region : null; aRegionReadout.textContent = arr ? `Region: (${arr[0]}, ${arr[1]}, ${arr[2]}x${arr[3]})` : 'Region: (none)';
          const aRandomRegionReadout = document.createElement('small');
          const arrr = Array.isArray(act.random_region) ? act.random_region : null; aRandomRegionReadout.textContent = arrr ? `Random Region: (${arrr[0]}, ${arrr[1]}, ${arrr[2]}x${arrr[3]})` : 'Random Region: (none)';
          const aSeconds = document.createElement('input'); aSeconds.type='number'; aSeconds.placeholder='seconds'; aSeconds.value=(act.seconds!=null?act.seconds:'');
          const aPixels = document.createElement('input'); aPixels.type='number'; aPixels.placeholder='pixels'; aPixels.value=(act.pixels!=null?act.pixels:'');
          const aKey = document.createElement('input'); aKey.type='text'; aKey.placeholder='key'; aKey.value=act.key||'';
          const aMods = document.createElement('input'); aMods.type='text'; aMods.placeholder='modifiers (comma)'; aMods.value=(Array.isArray(act.modifiers)?act.modifiers.join(','):(act.modifiers||''));
          // Show/hide fields based on action type (mirror Sequences editor)
          function updateActionFieldsF(){
            const t = aType.value;
            const isMove = (t==='move_to'||t==='move'||t==='drag');
            aButton.style.display = (t==='click' ? 'inline-block' : 'none');
            aClicks.style.display = (t==='click' ? 'inline-block' : 'none');
            aX.style.display = (isMove ? 'inline-block' : 'none');
            aY.style.display = (isMove ? 'inline-block' : 'none');
            aRandom.style.display = (isMove ? 'inline-block' : 'none');
            aUseRegion.style.display = (isMove ? 'inline-block' : 'none');
            aUseRandomRegion.style.display = (isMove ? 'inline-block' : 'none');
            aDuration.style.display = ((t==='move'||t==='drag'||t==='move_to') ? 'inline-block' : 'none');
            aSeconds.style.display = (t==='wait' ? 'inline-block' : 'none');
            aPixels.style.display = (t==='scroll' ? 'inline-block' : 'none');
            const isKey = (t==='keypress');
            aKey.style.display = (isKey ? 'inline-block' : 'none');
            aMods.style.display = (isKey ? 'inline-block' : 'none');
            // Readouts when region-related
            aRegionReadout.style.display = (isMove ? 'inline-block' : 'none');
            aRandomRegionReadout.style.display = (isMove ? 'inline-block' : 'none');
          }
          updateActionFieldsF();
          aType.addEventListener('change', updateActionFieldsF);
          const aSave = document.createElement('button'); aSave.textContent='Save Action';
          aSave.onclick = async () => {
            try {
              const updated = { ...act };
              updated.type = aType.value;
              if (aButton.value) updated.button = aButton.value;
              if (aClicks.value !== '') updated.clicks = parseInt(aClicks.value,10);
              if (aX.value !== '') updated.x = parseInt(aX.value,10);
              if (aY.value !== '') updated.y = parseInt(aY.value,10);
              updated.random = !!aRandom.checked;
              if (aDuration.value !== '') updated.duration = parseFloat(aDuration.value);
              if (aSeconds.value !== '') updated.seconds = parseFloat(aSeconds.value);
              if (aPixels.value !== '') updated.pixels = parseInt(aPixels.value,10);
              if (aKey.value) updated.key = aKey.value;
              if (aMods.value) updated.modifiers = aMods.value.split(',').map(s=>s.trim()).filter(Boolean);
              const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, {
                method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ action: updated })
              });
              const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
              await loadFailsafeSteps();
              statusEl.textContent = `Status: saved action #${aidx} in step #${idx}`;
            } catch (e) { statusEl.textContent = `Status: action save failed (${e.message})`; }
          };
          const aDel = document.createElement('button'); aDel.textContent='Delete Action';
          aDel.onclick = async () => {
            try {
              const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'DELETE', headers: authHeaders() });
              const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
              await loadFailsafeSteps(); statusEl.textContent = `Status: deleted action #${aidx} in step #${idx}`;
            } catch (e) { statusEl.textContent = `Status: action delete failed (${e.message})`; }
          };
          const aUp = document.createElement('button'); aUp.textContent='Up'; aUp.onclick = async () => { await reorderFailsafeAction(idx, aidx, Math.max(0,aidx-1)); };
          const aDown = document.createElement('button'); aDown.textContent='Down'; aDown.onclick = async () => { const to = Math.min(actions.length-1,aidx+1); await reorderFailsafeAction(idx, aidx, to); };
          aRow.appendChild(aType); aRow.appendChild(aButton); aRow.appendChild(aClicks);
          aRow.appendChild(aX); aRow.appendChild(aY); aRow.appendChild(aRandom);
          aRow.appendChild(aDuration); aRow.appendChild(aSeconds); aRow.appendChild(aPixels);
          aRow.appendChild(aKey); aRow.appendChild(aMods);
          aRow.appendChild(aSave); aRow.appendChild(aUseRegion); aRow.appendChild(aUseRandomRegion); aRow.appendChild(aRegionReadout); aRow.appendChild(aRandomRegionReadout); aRow.appendChild(aUp); aRow.appendChild(aDown); aRow.appendChild(aDel);
          aDiv.appendChild(aRow);
          // Else actions list for this action
          const elseWrap = document.createElement('div'); elseWrap.className='actions';
          const elseTitle = document.createElement('small'); elseTitle.textContent='Else Actions:'; elseWrap.appendChild(elseTitle);
          const elseActions = Array.isArray(act.else_actions) ? act.else_actions : [];
          elseActions.forEach((ea, eidx) => {
            const eDiv = document.createElement('div'); eDiv.className='action';
            const eRow = document.createElement('div'); eRow.className='row';
            const eType = document.createElement('select'); ['click','wait','type','drag','move','move_to','keypress','scroll','click_and_hold'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; eType.appendChild(opt); }); eType.value = ea.type || ea.action || 'click';
            const eButton = document.createElement('select'); ['left','right','middle'].forEach(b=>{ const opt=document.createElement('option'); opt.value=b; opt.textContent=b; eButton.appendChild(opt); }); eButton.value = ea.button || 'left';
            const eClicks = document.createElement('input'); eClicks.type='number'; eClicks.placeholder='clicks'; eClicks.value=(ea.clicks!=null?ea.clicks:'');
            const eX = document.createElement('input'); eX.type='number'; eX.placeholder='X'; eX.value=(ea.x!=null?ea.x:'');
            const eY = document.createElement('input'); eY.type='number'; eY.placeholder='Y'; eY.value=(ea.y!=null?ea.y:'');
            const eRandom = document.createElement('input'); eRandom.type='checkbox'; eRandom.checked=!!ea.random; eRandom.title='Toggle Random';
            const eDuration = document.createElement('input'); eDuration.type='number'; eDuration.placeholder='duration'; eDuration.value=(ea.duration!=null?ea.duration:'');
            const eSeconds = document.createElement('input'); eSeconds.type='number'; eSeconds.placeholder='seconds'; eSeconds.value=(ea.seconds!=null?ea.seconds:'');
            const ePixels = document.createElement('input'); ePixels.type='number'; ePixels.placeholder='pixels'; ePixels.value=(ea.pixels!=null?ea.pixels:'');
            const eKey = document.createElement('input'); eKey.type='text'; eKey.placeholder='key'; eKey.value=ea.key||'';
            const eMods = document.createElement('input'); eMods.type='text'; eMods.placeholder='modifiers'; eMods.value=(Array.isArray(ea.modifiers)?ea.modifiers.join(','):(ea.modifiers||''));
            function updateElseFields(){ const t=eType.value; eButton.style.display=(t==='click'?'inline-block':'none'); eClicks.style.display=(t==='click'?'inline-block':'none'); const isMove=(t==='move_to'||t==='move'||t==='drag'); eX.style.display=(isMove?'inline-block':'none'); eY.style.display=(isMove?'inline-block':'none'); eRandom.style.display=(isMove?'inline-block':'none'); eDuration.style.display=((t==='move'||t==='drag'||t==='move_to')?'inline-block':'none'); eSeconds.style.display=(t==='wait'?'inline-block':'none'); ePixels.style.display=(t==='scroll'?'inline-block':'none'); eKey.style.display=(t==='keypress'?'inline-block':'none'); eMods.style.display=(t==='keypress'?'inline-block':'none'); }
            updateElseFields(); eType.addEventListener('change', updateElseFields);
            const eSave = document.createElement('button'); eSave.textContent='Save Else';
            eSave.onclick = async () => {
              try {
                const updated = { ...act };
                const newEA = { ...ea, type: eType.value };
                if (eButton.value) newEA.button = eButton.value;
                if (eClicks.value !== '') newEA.clicks = parseInt(eClicks.value,10);
                if (eX.value !== '') newEA.x = parseInt(eX.value,10);
                if (eY.value !== '') newEA.y = parseInt(eY.value,10);
                newEA.random = !!eRandom.checked;
                if (eDuration.value !== '') newEA.duration = parseFloat(eDuration.value);
                if (eSeconds.value !== '') newEA.seconds = parseFloat(eSeconds.value);
                if (ePixels.value !== '') newEA.pixels = parseInt(ePixels.value,10);
                if (eKey.value) newEA.key = eKey.value;
                if (eMods.value) newEA.modifiers = eMods.value.split(',').map(s=>s.trim()).filter(Boolean);
                const list = Array.isArray(updated.else_actions) ? [...updated.else_actions] : [];
                list[eidx] = newEA; updated.else_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: saved else action ${eidx} for #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: save failed (${e.message})`; }
            };
            const eDel = document.createElement('button'); eDel.textContent='Delete Else';
            eDel.onclick = async () => {
              try {
                const updated = { ...act };
                const list = Array.isArray(updated.else_actions) ? updated.else_actions.filter((_,i)=>i!==eidx) : [];
                updated.else_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: deleted else action ${eidx} for #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: delete failed (${e.message})`; }
            };
            eRow.appendChild(eType); eRow.appendChild(eButton); eRow.appendChild(eClicks);
            eRow.appendChild(eX); eRow.appendChild(eY); eRow.appendChild(eRandom);
            eRow.appendChild(eDuration); eRow.appendChild(eSeconds); eRow.appendChild(ePixels);
            eRow.appendChild(eKey); eRow.appendChild(eMods); eRow.appendChild(eSave); eRow.appendChild(eDel);
            eDiv.appendChild(eRow);
            elseWrap.appendChild(eDiv);
          });
          const addElseRow = document.createElement('div'); addElseRow.className='row';
          function addElseOfType(t, preset={}){
            return async () => {
              try {
                const updated = { ...act };
                const list = Array.isArray(updated.else_actions) ? [...updated.else_actions] : [];
                list.push({ type: t, ...preset }); updated.else_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: added else ${t} to action #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: add else failed (${e.message})`; }
            };
          }
          const elsePalette = [
            {label:'Add else click', t:'click'},
            {label:'Add else right_click', t:'click', preset:{button:'right'}},
            {label:'Add else double_click', t:'click', preset:{clicks:2}},
            {label:'Add else move', t:'move', preset:{duration:1.0}},
            {label:'Add else move_to', t:'move_to', preset:{duration:1.0}},
            {label:'Add else type', t:'type', preset:{text:'', delay:0.0}},
            {label:'Add else wait', t:'wait', preset:{seconds:0.5}},
            {label:'Add else scroll', t:'scroll', preset:{pixels:100}},
            {label:'Add else click_and_hold', t:'click_and_hold', preset:{duration:1.0}}
          ];
          elsePalette.forEach(p=>{ const b=document.createElement('button'); b.textContent=p.label; b.onclick=addElseOfType(p.t, p.preset||{}); addElseRow.appendChild(b); });
          elseWrap.appendChild(addElseRow);
          aDiv.appendChild(elseWrap);
          // If-Not actions list for this action
          const ifNotWrap = document.createElement('div'); ifNotWrap.className='actions';
          const ifNotTitle = document.createElement('small'); ifNotTitle.textContent='If-Not Actions:'; ifNotWrap.appendChild(ifNotTitle);
          const ifNotActions = Array.isArray(act.if_not_actions) ? act.if_not_actions : [];
          ifNotActions.forEach((ina, iidx) => {
            const iDiv = document.createElement('div'); iDiv.className='action';
            const iRow = document.createElement('div'); iRow.className='row';
            const iType = document.createElement('select'); ['click','wait','type','drag','move','move_to','keypress','scroll','click_and_hold'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; iType.appendChild(opt); }); iType.value = ina.type || ina.action || 'click';
            const iButton = document.createElement('select'); ['left','right','middle'].forEach(b=>{ const opt=document.createElement('option'); opt.value=b; opt.textContent=b; iButton.appendChild(opt); }); iButton.value = ina.button || 'left';
            const iClicks = document.createElement('input'); iClicks.type='number'; iClicks.placeholder='clicks'; iClicks.value=(ina.clicks!=null?ina.clicks:'');
            const iX = document.createElement('input'); iX.type='number'; iX.placeholder='X'; iX.value=(ina.x!=null?ina.x:'');
            const iY = document.createElement('input'); iY.type='number'; iY.placeholder='Y'; iY.value=(ina.y!=null?ina.y:'');
            const iRandom = document.createElement('input'); iRandom.type='checkbox'; iRandom.checked=!!ina.random; iRandom.title='Toggle Random';
            const iDuration = document.createElement('input'); iDuration.type='number'; iDuration.placeholder='duration'; iDuration.value=(ina.duration!=null?ina.duration:'');
            const iSeconds = document.createElement('input'); iSeconds.type='number'; iSeconds.placeholder='seconds'; iSeconds.value=(ina.seconds!=null?ina.seconds:'');
            const iPixels = document.createElement('input'); iPixels.type='number'; iPixels.placeholder='pixels'; iPixels.value=(ina.pixels!=null?ina.pixels:'');
            const iKey = document.createElement('input'); iKey.type='text'; iKey.placeholder='key'; iKey.value=ina.key||'';
            const iMods = document.createElement('input'); iMods.type='text'; iMods.placeholder='modifiers'; iMods.value=(Array.isArray(ina.modifiers)?ina.modifiers.join(','):(ina.modifiers||''));
            function updateIfNotFields(){ const t=iType.value; iButton.style.display=(t==='click'?'inline-block':'none'); iClicks.style.display=(t==='click'?'inline-block':'none'); const isMove=(t==='move_to'||t==='move'||t==='drag'); iX.style.display=(isMove?'inline-block':'none'); iY.style.display=(isMove?'inline-block':'none'); iRandom.style.display=(isMove?'inline-block':'none'); iDuration.style.display=((t==='move'||t==='drag'||t==='move_to')?'inline-block':'none'); iSeconds.style.display=(t==='wait'?'inline-block':'none'); iPixels.style.display=(t==='scroll'?'inline-block':'none'); iKey.style.display=(t==='keypress'?'inline-block':'none'); iMods.style.display=(t==='keypress'?'inline-block':'none'); }
            updateIfNotFields(); iType.addEventListener('change', updateIfNotFields);
            const iSave = document.createElement('button'); iSave.textContent='Save If-Not';
            iSave.onclick = async () => {
              try {
                const updated = { ...act };
                const newINA = { ...ina, type: iType.value };
                if (iButton.value) newINA.button = iButton.value;
                if (iClicks.value !== '') newINA.clicks = parseInt(iClicks.value,10);
                if (iX.value !== '') newINA.x = parseInt(iX.value,10);
                if (iY.value !== '') newINA.y = parseInt(iY.value,10);
                newINA.random = !!iRandom.checked;
                if (iDuration.value !== '') newINA.duration = parseFloat(iDuration.value);
                if (iSeconds.value !== '') newINA.seconds = parseFloat(iSeconds.value);
                if (iPixels.value !== '') newINA.pixels = parseInt(iPixels.value,10);
                if (iKey.value) newINA.key = iKey.value;
                if (iMods.value) newINA.modifiers = iMods.value.split(',').map(s=>s.trim()).filter(Boolean);
                const list = Array.isArray(updated.if_not_actions) ? [...updated.if_not_actions] : [];
                list[iidx] = newINA; updated.if_not_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: saved if-not action ${iidx} for #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: save failed (${e.message})`; }
            };
            const iDel = document.createElement('button'); iDel.textContent='Delete If-Not';
            iDel.onclick = async () => {
              try {
                const updated = { ...act };
                const list = Array.isArray(updated.if_not_actions) ? updated.if_not_actions.filter((_,i)=>i!==iidx) : [];
                updated.if_not_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: deleted if-not action ${iidx} for #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: delete failed (${e.message})`; }
            };
            iRow.appendChild(iType); iRow.appendChild(iButton); iRow.appendChild(iClicks);
            iRow.appendChild(iX); iRow.appendChild(iY); iRow.appendChild(iRandom);
            iRow.appendChild(iDuration); iRow.appendChild(iSeconds); iRow.appendChild(iPixels);
            iRow.appendChild(iKey); iRow.appendChild(iMods); iRow.appendChild(iSave); iRow.appendChild(iDel);
            iDiv.appendChild(iRow);
            ifNotWrap.appendChild(iDiv);
          });
          const addIfNotRow = document.createElement('div'); addIfNotRow.className='row';
          function addIfNotOfType(t, preset={}){
            return async () => {
              try {
                const updated = { ...act };
                const list = Array.isArray(updated.if_not_actions) ? [...updated.if_not_actions] : [];
                list.push({ type: t, ...preset }); updated.if_not_actions = list;
                const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions/${aidx}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: updated }) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                await loadFailsafeSteps();
                statusEl.textContent = `Status: added if-not ${t} to action #${aidx}`;
              } catch (e) { statusEl.textContent = `Status: add if-not failed (${e.message})`; }
            };
          }
          const ifNotPalette = [
            {label:'Add if-not click', t:'click'},
            {label:'Add if-not right_click', t:'click', preset:{button:'right'}},
            {label:'Add if-not double_click', t:'click', preset:{clicks:2}},
            {label:'Add if-not move', t:'move', preset:{duration:1.0}},
            {label:'Add if-not move_to', t:'move_to', preset:{duration:1.0}},
            {label:'Add if-not type', t:'type', preset:{text:'', delay:0.0}},
            {label:'Add if-not wait', t:'wait', preset:{seconds:0.5}},
            {label:'Add if-not scroll', t:'scroll', preset:{pixels:100}},
            {label:'Add if-not click_and_hold', t:'click_and_hold', preset:{duration:1.0}}
          ];
          ifNotPalette.forEach(p=>{ const b=document.createElement('button'); b.textContent=p.label; b.onclick=addIfNotOfType(p.t, p.preset||{}); addIfNotRow.appendChild(b); });
          ifNotWrap.appendChild(addIfNotRow);
          aDiv.appendChild(ifNotWrap);
          actionsWrap.appendChild(aDiv);
        });
        const addActionRow = document.createElement('div'); addActionRow.className='row';
        const addActionType = document.createElement('select'); ['click','wait','type','drag','move','move_to','keypress','scroll'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; addActionType.appendChild(opt); });
        const addActionBtn = document.createElement('button'); addActionBtn.textContent='Add Action';
        addActionBtn.onclick = async () => {
          try {
            const newAction = { type: addActionType.value };
            const res = await fetch(`${apiBase}/api/failsafe/sequence/${idx}/actions`, { method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ action: newAction }) });
            const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            await loadFailsafeSteps(); statusEl.textContent = `Status: added action to step #${idx}`;
          } catch (e) { statusEl.textContent = `Status: add action failed (${e.message})`; }
        };
        addActionRow.appendChild(addActionType); addActionRow.appendChild(addActionBtn);
        actionsWrap.appendChild(addActionRow);
        div.appendChild(actionsWrap);
        stepsEl.appendChild(div);
      });
    }

    async function reorderFailsafeAction(stepIdx, fromIdx, toIdx) {
      if (fromIdx === toIdx) return;
      try {
        const res = await fetch(`${apiBase}/api/failsafe/sequence/${stepIdx}/actions/reorder`, {
          method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ from_index: fromIdx, to_index: toIdx })
        });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        await loadFailsafeSteps(); statusEl.textContent = `Status: reordered action ${fromIdx}  ${toIdx}`;
      } catch (e) { statusEl.textContent = `Status: action reorder failed (${e.message})`; }
    }

    async function reorderFailsafeStep(fromIdx, toIdx) {
      if (fromIdx === toIdx) return;
      try {
        const res = await fetch(`${apiBase}/api/failsafe/sequence/reorder`, {
          method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ from_index: fromIdx, to_index: toIdx })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        await loadFailsafeSteps();
        statusEl.textContent = `Status: reordered step ${fromIdx}  ${toIdx}`;
      } catch (e) { statusEl.textContent = `Status: reorder failed (${e.message})`; }
    }

    // Removed addStep() in favor of per-step action palette

    async function deleteStep(index) {
      try {
        const res = await fetch(`${apiBase}/api/failsafe/sequence/${index}`, { method: 'DELETE', headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        await loadFailsafeSteps();
        statusEl.textContent = `Status: deleted step #${index}`;
      } catch (e) { statusEl.textContent = `Status: delete failed (${e.message})`; }
    }

    document.getElementById('btnSave').addEventListener('click', saveFailsafe);
    document.getElementById('btnFsAddStep').addEventListener('click', async () => {
      try {
        const stepObj = { find: '', required: true, timeout: 10, confidence: 0.9, detection_strategy: 'default', monitor: null, actions: [] };
        const res = await fetch(`${apiBase}/api/failsafe/sequence`, { method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ step: stepObj }) });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        await loadFailsafeSteps(); statusEl.textContent = `Status: added step #${data.index}`;
      } catch (e) { statusEl.textContent = `Status: add step failed (${e.message})`; }
    });
    document.getElementById('btnFsAddGroupCall').addEventListener('click', async () => {
      try {
        const chosen = document.getElementById('fsGroupSelect').value;
        const res = await fetch(`${apiBase}/api/failsafe/sequence`, { method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ step: { call_group: chosen } }) });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        await loadFailsafeSteps(); statusEl.textContent = `Status: added group call step #${data.index}`;
      } catch (e) { statusEl.textContent = `Status: add failed (${e.message})`; }
    });
    document.getElementById('btnFsUsePreviewRegion').addEventListener('click', async () => {
      if (!lastFsRegion) { statusEl.textContent = 'Status: select a region on the preview first'; return; }
      try {
        // Update the global failsafe region using the selected preview region
        const payload = {
          enabled: (document.getElementById('fsEnabled').value === 'true'),
          template_name: document.getElementById('fsTemplate').value || null,
          confidence: parseFloat(document.getElementById('fsConfidence').value || '0.8'),
          region: lastFsRegion
        };
        const res = await fetch(`${apiBase}/api/failsafe`, { method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        document.getElementById('fsRegion').value = lastFsRegion.join(',');
        statusEl.textContent = 'Status: applied preview region to failsafe';
      } catch (e) { statusEl.textContent = `Status: apply failed (${e.message})`; }
    });
    tokenEl.addEventListener('change', () => { loadTemplates(); loadFailsafe(); loadFailsafeSteps(); fetchFsMonitors().then(updateFsPreviewSrc); fetchFsGroups(); });
    const urlTok = new URLSearchParams(location.search).get('token');
    if (urlTok) { tokenEl.value = urlTok; }
    loadTemplates().then(() => { loadFailsafe(); loadFailsafeSteps(); fetchFsMonitors().then(()=>{ updateFsPreviewSrc(); const fsSizeEl = document.getElementById('fsPreviewSize'); if (fsSizeEl) { const val = parseInt(fsSizeEl.value||'1024',10); if (!isNaN(val)&&val>0){ fsPreview.style.width = `${val}px`; } } }); fetchFsGroups(); });

    // Preview setup (failsafe)
    const fsPreview = document.getElementById('fsPreview');
    const fsSel = document.getElementById('fsSel');
    const fsImgPane = document.getElementById('fsImagePane');
    const fsPhoneToggle = document.getElementById('fsPhoneToggle');
    let fsMonitors = [];
    let fsSelectedMonitor = 0;
    // Prevent browser dragging the image so region selection works
    fsPreview.addEventListener('dragstart', (e) => e.preventDefault());
    async function fetchFsMonitors() {
      try {
        const res = await fetch(`${apiBase}/api/monitors`, { headers: authHeaders() });
        const data = await res.json();
        fsMonitors = data.monitors || [];
        const sel = document.getElementById('fsMonitor');
        sel.innerHTML = '';
        for (const m of fsMonitors) {
          const opt = document.createElement('option');
          opt.value = String(m.index);
          opt.textContent = (m.index === 0) ? `All (${m.width}x${m.height})` : `Monitor ${m.index} (${m.width}x${m.height})`;
          sel.appendChild(opt);
        }
        sel.value = String(fsSelectedMonitor);
      } catch (e) { /* ignore */ }
    }
    function updateFsPreviewSrc() {
      const tok = tokenEl.value.trim();
      const monParam = `monitor=${encodeURIComponent(String(fsSelectedMonitor))}`;
      const q = [monParam];
      if (tok) q.push(`token=${encodeURIComponent(tok)}`);
      fsPreview.src = `${apiBase}/stream.mjpeg?${q.join('&')}`;
    }
    tokenEl.addEventListener('change', updateFsPreviewSrc);
    document.getElementById('fsMonitor').addEventListener('change', (e) => { fsSelectedMonitor = parseInt(e.target.value, 10); updateFsPreviewSrc(); });
    // Preview resizing
    function setFsPreviewSize(){ const el = document.getElementById('fsPreviewSize'); if (!el) return; const val = parseInt(el.value||'1024',10); if (!isNaN(val)&&val>0){ fsPreview.style.width = `${val}px`; } }
    const fsSizeEl = document.getElementById('fsPreviewSize'); if (fsSizeEl) { fsSizeEl.addEventListener('change', setFsPreviewSize); setFsPreviewSize(); }
    updateFsPreviewSrc();
    let fsDragStart = null;
    // Compute actual drawn image content rect inside the <img> (object-fit: contain)
    function getFsImageContentInfo(img){
      const rect = img.getBoundingClientRect();
      const nw = img.naturalWidth || rect.width;
      const nh = img.naturalHeight || rect.height;
      const elemW = rect.width, elemH = rect.height;
      let contentW = elemW;
      let contentH = contentW * (nh / nw);
      if (contentH > elemH){ contentH = elemH; contentW = contentH * (nw / nh); }
      const offsetX = (elemW - contentW) / 2;
      const offsetY = (elemH - contentH) / 2;
      return { rect, nw, nh, contentW, contentH, offsetX, offsetY };
    }
    let fsLastDragPos = null;
    function fsStartDrag(clientX, clientY){
      const paneRect = fsImgPane.getBoundingClientRect();
      const info = getFsImageContentInfo(fsPreview);
      const ix = clientX - info.rect.left - info.offsetX;
      const iy = clientY - info.rect.top - info.offsetY;
      if (ix < 0 || iy < 0 || ix > info.contentW || iy > info.contentH) return;
      const offX = (info.rect.left - paneRect.left) + info.offsetX;
      const offY = (info.rect.top - paneRect.top) + info.offsetY;
      fsDragStart = { x: ix, y: iy, offX, offY };
      fsSel.style.display = 'block';
      fsSel.style.left = `${offX + ix}px`;
      fsSel.style.top = `${offY + iy}px`;
      fsSel.style.width = '0px';
      fsSel.style.height = '0px';
    }
    function fsMoveDrag(clientX, clientY){
      if (!fsDragStart) return;
      const info = getFsImageContentInfo(fsPreview);
      let ix = clientX - info.rect.left - info.offsetX; let iy = clientY - info.rect.top - info.offsetY;
      ix = Math.max(0, Math.min(info.contentW, ix));
      iy = Math.max(0, Math.min(info.contentH, iy));
      fsLastDragPos = { x: ix, y: iy };
      const left = Math.min(fsDragStart.x, ix) + fsDragStart.offX;
      const top = Math.min(fsDragStart.y, iy) + fsDragStart.offY;
      const w = Math.abs(ix - fsDragStart.x);
      const h = Math.abs(iy - fsDragStart.y);
      fsSel.style.left = `${left}px`;
      fsSel.style.top = `${top}px`;
      fsSel.style.width = `${w}px`;
      fsSel.style.height = `${h}px`;
    }
    function fsEndDrag(){
      if (!fsDragStart) return;
      const info = getFsImageContentInfo(fsPreview);
      const ix0 = Math.min(fsDragStart.x, (fsLastDragPos ? fsLastDragPos.x : fsDragStart.x));
      const iy0 = Math.min(fsDragStart.y, (fsLastDragPos ? fsLastDragPos.y : fsDragStart.y));
      const iw = Math.abs(((fsLastDragPos ? fsLastDragPos.x : fsDragStart.x)) - fsDragStart.x);
      const ih = Math.abs(((fsLastDragPos ? fsLastDragPos.y : fsDragStart.y)) - fsDragStart.y);
      const scaleX = info.nw / info.contentW;
      const scaleY = info.nh / info.contentH;
      const x0 = Math.round(ix0 * scaleX);
      const y0 = Math.round(iy0 * scaleY);
      const rw = Math.round(iw * scaleX);
      const rh = Math.round(ih * scaleY);
      lastFsRegion = [x0, y0, rw, rh];
      statusEl.textContent = `Status: selected region ${x0},${y0},${rw},${rh}`;
      fsDragStart = null;
      fsLastDragPos = null;
    }
    // Mouse events
    fsPreview.addEventListener('mousedown', (e) => { fsStartDrag(e.clientX, e.clientY); });
    fsPreview.addEventListener('mousemove', (e) => { fsMoveDrag(e.clientX, e.clientY); });
    window.addEventListener('mouseup', () => { fsEndDrag(); });
    // Touch events when Using Phone is enabled
    fsPreview.addEventListener('touchstart', (e) => { if (!fsPhoneToggle.checked) return; e.preventDefault(); const t=e.touches[0]; if (t) fsStartDrag(t.clientX, t.clientY); }, { passive: false });
    fsPreview.addEventListener('touchmove', (e) => { if (!fsPhoneToggle.checked || !fsDragStart) return; e.preventDefault(); const t=e.touches[0]; if (t) fsMoveDrag(t.clientX, t.clientY); }, { passive: false });
    window.addEventListener('touchend', () => { if (!fsPhoneToggle.checked) return; fsEndDrag(); });
    // Prevent scroll during selection when using phone
    function updateFsTouchAction(){ fsImgPane.style.touchAction = fsPhoneToggle.checked ? 'none' : 'auto'; }
    fsPhoneToggle.addEventListener('change', updateFsTouchAction);
    updateFsTouchAction();
  </script>
</body>
</html>